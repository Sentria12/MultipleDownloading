<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Download Files</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { background: #f5f7fa; padding: 20px; color: #333; }
    .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #5a67d8; margin-bottom: 15px; }
    h3 { margin: 18px 0 8px; color: #4a5568; font-size: 16px; }

    #server-file-list { max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px; background: #fdfdfe; }
    .file-item { padding: 8px 10px; margin: 3px 0; background: #ebf8ff; border-radius: 6px; cursor: grab; display: flex; align-items: center; justify-content: space-between; }
    .file-item:hover { background: #bee3f8; }
    .file-info { display: flex; align-items: center; gap: 8px; flex: 1; }
    .file-size { font-size: 12px; color: #718096; background: #edf2f7; padding: 2px 6px; border-radius: 4px; }

    .controls { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
    .controls button { padding: 8px 14px; background: #5a67d8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .controls button:hover { background: #4c51bf; }

    .drop-container { display: flex; align-items: center; gap: 12px; margin-top: 10px; }
    .drop-zone {
      flex: 1; border: 2px dashed #5a67d8; border-radius: 8px; padding: 16px; text-align: center;
      background: #f8f9ff; transition: 0.3s;
      font-size: 15px; color: #5a67d8; font-weight: 500; min-height: 80px;
    }
    .drop-zone.drag-over { background: #e6f7ff; border-color: #3182ce; transform: scale(1.01); }

    #queued-files { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
    .queued-item { background: #bee3f8; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: #1e40af; display: flex; align-items: center; gap: 6px; }

    .loading-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; width: 120px; }
    .loading-fill { height: 100%; background: #5a67d8; width: 0%; transition: width 0.3s; }

    #history-area { max-height: 200px; overflow-y: auto; background: #f9f9f9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; font-size: 13px; line-height: 1.5; }
    #clear-history-button { background: #e53e3e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
    
    /* Task item styles */
    .task-item { padding: 10px; margin: 5px 0; background: #f7fafc; border-radius: 6px; border-left: 3px solid #5a67d8; }
    .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .task-name { font-weight: 500; color: #2d3748; flex: 1; }
    .task-size-info { font-size: 12px; color: #718096; margin-left: 10px; }
    .progress-container { display: flex; align-items: center; gap: 12px; margin: 5px 0; }
    .progress-bar { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #5a67d8, #4c51bf); width: 0%; transition: width 0.3s; }
    .progress-text { font-size: 11px; color: #4a5568; min-width: 80px; text-align: right; }
    .task-status { font-size: 12px; color: #718096; margin-top: 3px; }

    /* Notification styles */
    .notification { margin-bottom: 5px; padding: 3px 0; border-bottom: 1px solid #e2e8f0; }
    .notification:last-child { border-bottom: none; }

    .total-size { font-size: 12px; color: #718096; margin-left: 8px; }
  </style>
</head>
<body>

<div class="container">
  <h2>Download Files</h2>

  <div class="controls">
    <button id="refresh-btn">L√†m m·ªõi</button>
    <button id="download-selected">T·∫£i ƒë√£ ch·ªçn</button>
  </div>

  <div id="server-file-list"></div>

  <h3>Danh s√°ch T√°c v·ª•</h3>
  <div id="progress-list"></div>

  <div class="drop-container">
    <div class="drop-zone" id="dropZone">
      <div id="drop-zone-content">K√©o file .txt ho·∫∑c file t·ª´ danh s√°ch v√†o ƒë√¢y</div>
      <div id="queued-files"></div>
      <input type="file" id="fileInput" accept=".txt" hidden>
    </div>
    <div class="loading-bar">
      <div class="loading-fill" id="global-loading"></div>
    </div>
  </div>

  <div class="controls" style="margin-top: 10px;">
    <button id="download-queued">T·∫£i h√†ng ƒë·ª£i (<span id="queue-count">0</span>)</button>
    <button id="clear-queued" style="background: #e53e3e;">X√≥a h√†ng ƒë·ª£i</button>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
    <h3>Th√¥ng b√°o</h3>
    <button id="clear-history-button">X√≥a</button>
  </div>
  <div id="history-area"><div>Ch∆∞a c√≥ th√¥ng b√°o.</div></div>
</div>

<script>
  // === B·∫¢O M·∫¨T: API Key - kh·ªõp v·ªõi backend ===
  const API_KEY = "123456";

  // Khai b√°o bi·∫øn to√†n c·ª•c
  let activeDownloads = 0;
  let downloadQueue = new Set();
  let fileSizeCache = new Map();

  // ==== H√†m ƒë·ªãnh d·∫°ng dung l∆∞·ª£ng ====
  // ==== H√†m ƒë·ªãnh d·∫°ng dung l∆∞·ª£ng ====
function formatFileSize(bytes) {
    // Ki·ªÉm tra n·∫øu bytes kh√¥ng h·ª£p l·ªá
    if (bytes === null || bytes === undefined || isNaN(bytes) || bytes < 0) {
        return "0 B";
    }
    
    bytes = parseInt(bytes); // ƒê·∫£m b·∫£o l√† s·ªë nguy√™n
    
    if (bytes === 0) return "0 B";
    
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    let i = 0;
    let size = bytes;
    
    while (size >= k && i < sizes.length - 1) {
        size /= k;
        i++;
    }
    
    return size.toFixed(1) + " " + sizes[i];
}

  // ==== H√†m th√™m th√¥ng b√°o ====
  function addNotification(message, type = 'info') {
    const historyArea = document.getElementById('history-area');
    if (!historyArea) {
      console.error('Kh√¥ng t√¨m th·∫•y history-area');
      return;
    }
    
    // X√≥a "Ch∆∞a c√≥ th√¥ng b√°o" n·∫øu c√≥
    if (historyArea.textContent.includes('Ch∆∞a c√≥ th√¥ng b√°o')) {
      historyArea.innerHTML = '';
    }
    
    const notification = document.createElement('div');
    notification.className = 'notification';
    const timestamp = new Date().toLocaleTimeString();
    
    // Icon theo lo·∫°i th√¥ng b√°o
    let icon = 'üì¢';
    if (type === 'success') icon = '‚úÖ';
    if (type === 'error') icon = '‚ùå';
    if (type === 'warning') icon = '‚ö†Ô∏è';
    if (type === 'download') icon = 'üì•';
    
    notification.innerHTML = `<strong>${icon} [${timestamp}]</strong> ${message}`;
    
    // M√†u s·∫Øc theo lo·∫°i th√¥ng b√°o
    if (type === 'success') notification.style.color = '#059669';
    if (type === 'error') notification.style.color = '#dc2626';
    if (type === 'warning') notification.style.color = '#d97706';
    if (type === 'download') notification.style.color = '#2563eb';
    
    // Th√™m v√†o ƒë·∫ßu danh s√°ch
    historyArea.prepend(notification);
    
    // T·ª± ƒë·ªông scroll l√™n ƒë·∫ßu
    historyArea.scrollTop = 0;
    
    console.log(`Th√¥ng b√°o: ${message}`);
  }

  // ==== K√©o th·∫£ =====
  function setupDragDrop() {
    const dropZone = document.getElementById('dropZone');
    if (!dropZone) {
      console.error('Kh√¥ng t√¨m th·∫•y dropZone');
      return;
    }

    dropZone.addEventListener('dragover', e => { 
      e.preventDefault(); 
      dropZone.classList.add('drag-over'); 
    });
    
    dropZone.addEventListener('dragleave', () => { 
      dropZone.classList.remove('drag-over'); 
    });
    
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');

      if (e.dataTransfer.files.length) {
        const txtFiles = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.txt'));
        if (txtFiles.length === 0) {
          addNotification('Kh√¥ng c√≥ file .txt n√†o ƒë∆∞·ª£c k√©o v√†o', 'warning');
          return;
        }
        
        txtFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = ev => {
            const names = ev.target.result.split('\n')
              .map(l => l.trim())
              .filter(l => l && !l.startsWith('#'));
            
            if (names.length === 0) {
              addNotification(`File ${file.name} kh√¥ng c√≥ t√™n file h·ª£p l·ªá`, 'warning');
              return;
            }
            
            names.forEach(name => addToQueue(name));
            addNotification(`ƒê√£ th√™m ${names.length} file t·ª´ ${file.name} v√†o h√†ng ƒë·ª£i`, 'success');
          };
          reader.onerror = () => {
            addNotification(`L·ªói ƒë·ªçc file ${file.name}`, 'error');
          };
          reader.readAsText(file);
        });
      } else {
        const name = e.dataTransfer.getData('text/plain');
        if (name) {
          addToQueue(name);
        }
      }
    });
  }

  function addToQueue(filename) {
    if (downloadQueue.has(filename)) {
      addNotification(`File "${filename}" ƒë√£ c√≥ trong h√†ng ƒë·ª£i`, 'warning');
      return;
    }
    downloadQueue.add(filename);
    updateQueueDisplay();
    addNotification(`ƒê√£ th√™m v√†o h√†ng ƒë·ª£i: ${filename}`, 'info');
  }

  function updateQueueDisplay() {
    const queueCountSpan = document.getElementById('queue-count');
    const queuedFilesDiv = document.getElementById('queued-files');
    const dropZoneContent = document.getElementById('drop-zone-content');
    
    if (!queueCountSpan || !queuedFilesDiv || !dropZoneContent) {
      console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ hi·ªÉn th·ªã h√†ng ƒë·ª£i');
      return;
    }

    queueCountSpan.textContent = downloadQueue.size;
    queuedFilesDiv.innerHTML = '';

    downloadQueue.forEach(filename => {
      const div = document.createElement('div');
      div.className = 'queued-item';
      const fileSize = fileSizeCache.get(filename);
      const sizeText = fileSize ? ` (${fileSize.size_formatted})` : '';
      div.innerHTML = `<span>${filename}${sizeText}</span>`;
      queuedFilesDiv.appendChild(div);
    });

    dropZoneContent.style.display = downloadQueue.size === 0 ? 'block' : 'none';
  }

  function updateGlobalLoading() {
    const globalLoading = document.getElementById('global-loading');
    if (globalLoading) {
      globalLoading.style.width = activeDownloads > 0 ? '70%' : '0%';
    }
  }

  // ==== T·∫£i file ====
  function downloadFile(filename) {
    activeDownloads++;
    updateGlobalLoading();
    
    const fileInfo = fileSizeCache.get(filename);
    const totalSize = fileInfo ? fileInfo.size_bytes : 0;
    const totalSizeFormatted = fileInfo ? fileInfo.size_formatted : 'ƒêang t·∫£i...';
    
    addNotification(`B·∫Øt ƒë·∫ßu t·∫£i file: ${filename} (${totalSizeFormatted})`, 'download');
    
    const progressList = document.getElementById('progress-list');
    if (!progressList) {
      console.error('Kh√¥ng t√¨m th·∫•y progress-list');
      return;
    }

    const id = 'dl-' + Date.now();
    const item = document.createElement('div');
    item.className = 'task-item';
    item.id = id;
    item.innerHTML = `
      <div class="task-header">
        <div class="task-name">${filename}</div>
        <div class="task-size-info">${totalSizeFormatted}</div>
      </div>
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
        <div class="progress-text" id="progress-text-${id}">0% (0 B)</div>
      </div>
      <div class="task-status">ƒêang t·∫£i...</div>
    `;
    progressList.appendChild(item);

    const xhr = new XMLHttpRequest();
    const encodedFilename = encodeURIComponent(filename);
    const url = `/api/download/${encodedFilename}`;
    console.log('Downloading:', filename, '‚Üí', url);
    
    xhr.open('GET', url, true);
    xhr.setRequestHeader("X-API-Key", API_KEY);
    xhr.responseType = 'blob';

    xhr.onprogress = e => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        const loadedFormatted = formatFileSize(e.loaded);
        const totalFormatted = formatFileSize(e.total);
        
        const progressFill = item.querySelector('.progress-fill');
        const progressText = item.querySelector('.progress-text');
        const taskStatus = item.querySelector('.task-status');
        
        if (progressFill) progressFill.style.width = pct + '%';
        if (progressText) progressText.textContent = `${pct}% (${loadedFormatted})`;
        if (taskStatus) taskStatus.textContent = `ƒêang t·∫£i... ${loadedFormatted} / ${totalFormatted}`;
      }
    };

    xhr.onload = () => {
      console.log('Download response:', xhr.status, xhr.statusText);
      const fileSizeHeader = xhr.getResponseHeader('X-File-Size');
      const actualTotalSize = fileSizeHeader ? parseInt(fileSizeHeader) : totalSize;
      const actualTotalFormatted = formatFileSize(actualTotalSize);
      
      const progressFill = item.querySelector('.progress-fill');
      const progressText = item.querySelector('.progress-text');
      const taskStatus = item.querySelector('.task-status');
      const taskSizeInfo = item.querySelector('.task-size-info');
      
      if (xhr.status === 200) {
        const blob = xhr.response;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        if (taskStatus) taskStatus.textContent = '‚úÖ Ho√†n th√†nh';
        if (progressFill) {
          progressFill.style.width = '100%';
          progressFill.style.background = '#48bb78';
        }
        if (progressText) progressText.textContent = `100% (${actualTotalFormatted})`;
        if (taskSizeInfo) taskSizeInfo.textContent = actualTotalFormatted;
        
        addNotification(`‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng: ${filename} (${actualTotalFormatted})`, 'success');
      } else {
        console.error('Download failed:', xhr.status);
        if (taskStatus) taskStatus.textContent = `‚ùå L·ªói ${xhr.status}`;
        if (progressFill) progressFill.style.background = '#e53e3e';
        if (progressText) progressText.textContent = `L·ªói ${xhr.status}`;
        addNotification(`‚ùå L·ªói t·∫£i file "${filename}": HTTP ${xhr.status}`, 'error');
      }
      activeDownloads--;
      updateGlobalLoading();
      setTimeout(() => {
        if (document.getElementById(id)) {
          item.remove();
        }
      }, 3000);
    };

    xhr.onerror = () => {
      const taskStatus = item.querySelector('.task-status');
      const progressFill = item.querySelector('.progress-fill');
      const progressText = item.querySelector('.progress-text');
      
      if (taskStatus) taskStatus.textContent = '‚ùå L·ªói k·∫øt n·ªëi';
      if (progressFill) progressFill.style.background = '#e53e3e';
      if (progressText) progressText.textContent = 'L·ªói k·∫øt n·ªëi';
      activeDownloads--;
      updateGlobalLoading();
      addNotification(`‚ùå L·ªói k·∫øt n·ªëi khi t·∫£i file: ${filename}`, 'error');
      setTimeout(() => {
        if (document.getElementById(id)) {
          item.remove();
        }
      }, 3000);
    };

    xhr.send();
  }

  // ==== Load danh s√°ch file t·ª´ server ====
  async function loadFiles() {
    try {
      addNotification('ƒêang t·∫£i danh s√°ch file t·ª´ server...', 'info');
      
      const res = await fetch('/api/files', {
        headers: { "X-API-Key": API_KEY }
      });

      console.log('Files response:', res.status);
      
      if (!res.ok) {
        if (res.status === 401) {
          throw new Error('API Key kh√¥ng h·ª£p l·ªá');
        }
        throw new Error(`HTTP ${res.status}`);
      }

      const files = await res.json();
      console.log('Files loaded:', files);
      
      // Cache dung l∆∞·ª£ng file
      fileSizeCache.clear();
      files.forEach(file => {
        fileSizeCache.set(file.name, file);
      });
      
      const serverList = document.getElementById('server-file-list');
      if (!serverList) {
        console.error('Kh√¥ng t√¨m th·∫•y server-file-list');
        return;
      }
      
      serverList.innerHTML = '';
      
      if (files.length === 0) {
        serverList.innerHTML = '<div style="padding:10px;text-align:center;color:#718096;">Ch∆∞a c√≥ file n√†o trong th∆∞ m·ª•c uploads/</div>';
        addNotification('Kh√¥ng c√≥ file n√†o trong th∆∞ m·ª•c uploads', 'warning');
        return;
      }
      
      // T√≠nh t·ªïng dung l∆∞·ª£ng - s·ª≠a l·ªói NaN
      const totalSizeBytes = files.reduce((sum, file) => {
        const size = file.size_bytes || 0;
        return sum + size;
      }, 0);
      
      const totalSizeFormatted = formatFileSize(totalSizeBytes);
      
      files.forEach(file => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.draggable = true;
        div.dataset.name = file.name;
        div.innerHTML = `
          <div class="file-info">
            <input type="checkbox" value="${file.name}">
            <span>${file.name}</span>
          </div>
          <span class="file-size">${file.size_formatted || '0 B'}</span>
        `;
        div.ondragstart = e => e.dataTransfer.setData('text/plain', file.name);
        serverList.appendChild(div);
      });

      // Th√™m th√¥ng tin t·ªïng dung l∆∞·ª£ng
      const totalInfo = document.createElement('div');
      totalInfo.style.padding = '8px 10px';
      totalInfo.style.fontSize = '12px';
      totalInfo.style.color = '#718096';
      totalInfo.style.textAlign = 'center';
      totalInfo.style.borderTop = '1px solid #e2e8f0';
      totalInfo.style.marginTop = '8px';
      totalInfo.textContent = `T·ªïng: ${files.length} file, ${totalSizeFormatted}`;
      serverList.appendChild(totalInfo);

      addNotification(`‚úÖ ƒê√£ t·∫£i ${files.length} file t·ª´ server (${totalSizeFormatted})`, 'success');
      
    } catch (error) {
      console.error("L·ªói k·∫øt n·ªëi server:", error);
      const serverList = document.getElementById('server-file-list');
      if (serverList) {
        serverList.innerHTML = '<div style="padding:10px;text-align:center;color:#e53e3e;">‚ùå L·ªói: ' + error.message + '</div>';
      }
      addNotification(`‚ùå L·ªói t·∫£i danh s√°ch file: ${error.message}`, 'error');
    }
  }

  // ==== Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng ====
  function initApp() {
    // Thi·∫øt l·∫≠p event listeners
    setupDragDrop();
    
    const refreshBtn = document.getElementById('refresh-btn');
    const downloadSelectedBtn = document.getElementById('download-selected');
    const downloadQueuedBtn = document.getElementById('download-queued');
    const clearQueuedBtn = document.getElementById('clear-queued');
    const clearHistoryBtn = document.getElementById('clear-history-button');
    
    if (refreshBtn) refreshBtn.onclick = () => {
      addNotification('ƒêang l√†m m·ªõi danh s√°ch file...', 'info');
      loadFiles();
    };

    if (downloadSelectedBtn) downloadSelectedBtn.onclick = () => {
      const selected = [...document.querySelectorAll('input:checked')].map(c => c.value);
      if (selected.length === 0) {
        addNotification('‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 file ƒë·ªÉ t·∫£i', 'warning');
        return;
      }
      
      // T√≠nh t·ªïng dung l∆∞·ª£ng file ƒë∆∞·ª£c ch·ªçn
      const totalSizeBytes = selected.reduce((sum, filename) => {
        const fileInfo = fileSizeCache.get(filename);
        const size = fileInfo ? (fileInfo.size_bytes || 0) : 0;
        return sum + size;
      }, 0);
      const totalSizeFormatted = formatFileSize(totalSizeBytes);
      
      selected.forEach(addToQueue);
      addNotification(`ƒê√£ th√™m ${selected.length} file v√†o h√†ng ƒë·ª£i t·∫£i (${totalSizeFormatted})`, 'success');
    };

    if (downloadQueuedBtn) downloadQueuedBtn.onclick = () => {
      if (downloadQueue.size === 0) {
        addNotification('‚ö†Ô∏è H√†ng ƒë·ª£i t·∫£i tr·ªëng', 'warning');
        return;
      }
      const files = Array.from(downloadQueue);
      downloadQueue.clear();
      updateQueueDisplay();
      
      // T√≠nh t·ªïng dung l∆∞·ª£ng h√†ng ƒë·ª£i
      const totalSizeBytes = files.reduce((sum, filename) => {
        const fileInfo = fileSizeCache.get(filename);
        const size = fileInfo ? (fileInfo.size_bytes || 0) : 0;
        return sum + size;
      }, 0);
      const totalSizeFormatted = formatFileSize(totalSizeBytes);
      
      addNotification(`üì• B·∫Øt ƒë·∫ßu t·∫£i ${files.length} file t·ª´ h√†ng ƒë·ª£i (${totalSizeFormatted})`, 'download');
      files.forEach(downloadFile);
    };

    if (clearQueuedBtn) clearQueuedBtn.onclick = () => {
      if (downloadQueue.size === 0) {
        addNotification('H√†ng ƒë·ª£i ƒë√£ tr·ªëng', 'info');
        return;
      }
      const count = downloadQueue.size;
      downloadQueue.clear();
      updateQueueDisplay();
      addNotification(`ƒê√£ x√≥a ${count} file kh·ªèi h√†ng ƒë·ª£i`, 'info');
    };

    if (clearHistoryBtn) clearHistoryBtn.onclick = () => {
      const historyArea = document.getElementById('history-area');
      if (historyArea) {
        historyArea.innerHTML = '<div>Ch∆∞a c√≥ th√¥ng b√°o.</div>';
      }
      addNotification('ƒê√£ x√≥a l·ªãch s·ª≠ th√¥ng b√°o', 'info');
    };

    
